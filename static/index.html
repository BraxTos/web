<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>Лабораторная работа №1 - Проверка попадания в область</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="header.css">
    <link rel="stylesheet" href="forms.css">
    <link rel="stylesheet" href="tables.css">
</head>

<body>
    <div class="header">
        <h1>Лабораторная работа №1 - Проверка попадания в область</h1>
        <div id="header-info">
            ФИО: Тоскуев Егор Денисович | Группа: P3332 | Вариант: 471572
        </div>
    </div>

    <div class="container">
        <h2>Проверка попадания точки в область на координатной плоскости</h2>
        <table class="form-table">
            <thead>
                <tr>
                    <th colspan="2" style="text-align: center; background-color: #34495e; color: white;">
                        Описание области попадания
                    </th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td width="30%"><strong>1-я четверть:</strong></td>
                    <td>Область попадания отсутствует</td>
                </tr>
                <tr>
                    <td><strong>2-я четверть:</strong></td>
                    <td>Прямоугольная область: -R ≤ x ≤ 0, 0 ≤ y ≤ R/2</td>
                </tr>
                <tr>
                    <td><strong>3-я четверть:</strong></td>
                    <td>Круговая область: x² + y² ≤ R², x ≤ 0, y ≤ 0</td>
                </tr>
                <tr>
                    <td><strong>4-я четверть:</strong></td>
                    <td>Треугольная область: 0 ≤ x ≤ R, -R ≤ y ≤ 0, x - y ≤ R</td>
                </tr>
            </tbody>
        </table>

        <form id="checkForm" method="POST">
            <table class="form-table">
                <thead>
                    <tr>
                        <th colspan="2" style="text-align: center; background-color: #34495e; color: white;">
                            Ввод параметров для проверки
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td width="30%">
                            <label for="x" class="form-label">Координата X (-5 до 5):</label>
                        </td>
                        <td width="70%">
                            <input type="text" id="x" name="x" required placeholder="Введите число от -5 до 5"
                                pattern="^-?\d+(\.\d+)?$" title="Введите число от -5 до 5">
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label for="y" class="form-label">Координата Y (-5 до 5):</label>
                        </td>
                        <td>
                            <input type="text" id="y" name="y" required placeholder="Введите число от -5 до 5"
                                pattern="^-?\d+(\.\d+)?$" title="Введите число от -5 до 5">
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label for="r" class="form-label">Параметр R (> 0):</label>
                        </td>
                        <td>
                            <input type="text" id="r" name="r" required placeholder="Введите положительное число"
                                pattern="^\d+(\.\d+)?$" title="Введите положительное число">
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align: center;">
                            <button type="submit" class="submit-btn" id="submitBtn">
                                Проверить попадание
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </form>

        <div id="result"></div>
    </div>

    <script>
        // Валидация значений в реальном времени
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('checkForm');
            const inputs = form.querySelectorAll('input[type="text"]');
            const submitBtn = document.getElementById('submitBtn');

            // Функция валидации одного поля
            function validateInput(input) {
                const value = input.value.trim();

                // Проверка на пустое значение
                if (value === '') {
                    return { isValid: false, message: 'Поле не может быть пустым' };
                }

                // Проверка, что это число
                if (isNaN(value)) {
                    return { isValid: false, message: 'Введите корректное число' };
                }

                const numValue = parseFloat(value);

                // Проверка диапазонов для X и Y
                if (input.name === 'x' || input.name === 'y') {
                    if (numValue < -5 || numValue > 5) {
                        return { isValid: false, message: 'Значение должно быть в диапазоне от -5 до 5' };
                    }
                }

                // Проверка положительности для R
                if (input.name === 'r') {
                    if (numValue <= 0) {
                        return { isValid: false, message: 'Значение должно быть положительным' };
                    }
                }

                return { isValid: true, message: '' };
            }

            // Функция проверки всей формы
            function validateForm() {
                let allValid = true;

                inputs.forEach(input => {
                    const validation = validateInput(input);
                    if (!validation.isValid) {
                        allValid = false;
                        input.style.borderColor = '#dc3545';
                        input.style.backgroundColor = '#fff5f5';
                        input.title = validation.message;
                    } else {
                        input.style.borderColor = '#28a745';
                        input.style.backgroundColor = '#f8fff8';
                        input.title = '';
                    }
                });

                submitBtn.disabled = !allValid;
                return allValid;
            }

            // Валидация при вводе данных
            inputs.forEach(input => {
                input.addEventListener('input', function () {
                    validateForm();
                });

                // Дополнительная валидация при потере фокуса
                input.addEventListener('blur', function () {
                    const validation = validateInput(this);
                    if (!validation.isValid && this.value.trim() !== '') {
                        // Показываем сообщение только если поле не пустое
                        this.style.borderColor = '#dc3545';
                        this.style.backgroundColor = '#fff5f5';
                        this.title = validation.message;
                    }
                });
            });

            // Валидация при отправке формы
            form.addEventListener('submit', function (e) {
                e.preventDefault();

                if (!validateForm()) {
                    alert('Пожалуйста, исправьте ошибки в форме перед отправкой');
                    return;
                }

                // Показываем индикатор загрузки
                document.getElementById('result').innerHTML =
                    '<div class="loading">Выполняется проверка попадания точки в область...</div>';

                // Создаем URLSearchParams для application/x-www-form-urlencoded
                const formData = new FormData(form);
                const urlParams = new URLSearchParams();

                for (let [key, value] of formData.entries()) {
                    urlParams.append(key, value);
                }

                // Отправляем как application/x-www-form-urlencoded
                fetch('/check', {
                    method: 'POST',
                    body: urlParams,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Accept': 'application/json'
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Ошибка сервера: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        displayResults(data);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        document.getElementById('result').innerHTML =
                            '<div style="color: red; text-align: center; padding: 20px; background: #fff5f5; border: 1px solid #dc3545; border-radius: 4px;">' +
                            'Ошибка соединения с сервером: ' + error.message + '</div>';
                    });
            });

            // Запускаем первоначальную валидацию
            validateForm();
        });

        function displayResults(data) {
            if (data.error) {
                document.getElementById('result').innerHTML =
                    '<div style="color: red; text-align: center; padding: 20px; background: #fff5f5; border: 1px solid #dc3545; border-radius: 4px;">' +
                    'Ошибка: ' + data.message + '</div>';
                return;
            }

            let html = '<div class="info">' +
                '<p><strong>Текущее время сервера:</strong> ' + data.currentTime + '</p>' +
                '<p><strong>Время выполнения скрипта:</strong> ' + data.scriptTime + ' мс</p>' +
                '<p><strong>Результат проверки:</strong> Точка с координатами (' + data.currentResult.x + ', ' + data.currentResult.y + ') при R=' + data.currentResult.r +
                ' - <strong style="color: ' + (data.currentResult.hit ? '#155724' : '#721c24') + ';">' +
                (data.currentResult.hit ? 'ПОПАДАНИЕ В ОБЛАСТЬ' : 'ПРОМАХ') + '</strong></p>' +
                '</div>';

            if (data.history && data.history.length > 0) {
                html += '<h3 style="text-align: center; margin: 25px 0 15px 0; color: #2c3e50;">История выполненных проверок</h3>' +
                    '<table class="results-table">' +
                    '<thead><tr>' +
                    '<th>Координата X</th>' +
                    '<th>Координата Y</th>' +
                    '<th>Параметр R</th>' +
                    '<th>Результат</th>' +
                    '<th>Время запроса</th>' +
                    '</tr></thead>' +
                    '<tbody>';

                data.history.forEach(result => {
                    const rowClass = result.hit ? 'hit-row' : 'miss-row';
                    html += '<tr class="' + rowClass + '">' +
                        '<td>' + result.x + '</td>' +
                        '<td>' + result.y + '</td>' +
                        '<td>' + result.r + '</td>' +
                        '<td><strong>' + (result.hit ? 'ПОПАДАНИЕ' : 'ПРОМАХ') + '</strong></td>' +
                        '<td>' + result.timestamp + '</td>' +
                        '</tr>';
                });

                html += '</tbody></table>';
            }

            document.getElementById('result').innerHTML = html;
        }
    </script>
</body>

</html>